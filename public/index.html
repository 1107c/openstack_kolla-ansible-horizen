<!DOCTYPE html>
<html>
<head>
    <title>VM Dashboard</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        button { margin: 2px; }
        .form-group { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
    </style>
</head>
<body>
    <h1>VM Dashboard</h1>
    
    <div>
        <h2>Create VM</h2>
        <div class="form-group">
            <label for="vmName">VM Name:</label>
            <input id="vmName" placeholder="VM Name">
        </div>
        <div class="form-group">
            <label for="imageId">Image:</label>
            <select id="imageId">
                <option value="">Select an Image</option>
            </select>
        </div>
        <div class="form-group">
            <label for="flavorId">Flavor:</label>
            <select id="flavorId">
                <option value="">Select a Flavor</option>
            </select>
        </div>
        <div class="form-group">
            <label for="networkId">Network:</label>
            <select id="networkId">
                <option value="">Select a Network</option>
            </select>
        </div>
        <button onclick="createVM()">Create VM</button>
    </div>

    <h2>VM List</h2>
    <table>
        <thead>
            <tr>
                <th>Instance</th>
                <th>Image</th>
                <th>Ip</th>
                <th>Flavor</th>
                <th>Status</th>
                <th>Availability_zone</th>
                <th>task_state</th>
                <th>vm_state</th>
                <th>Age</th>
            </tr>
        </thead>
        <tbody id="vmList"></tbody>
    </table>

    <h2>Image List</h2>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Visibility</th>
                <th>Protected</th>
                <th>Disk_format</th>
                <th>Size</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="imageList"></tbody>
    </table>

    <h2>Network List</h2>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Subnet</th>
                <th>Shared</th>
                <th>Status</th>
                <th>Availability_zone</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="networkList"></tbody>
    </table>    
    <script>
        // 공통 데이터 로딩 함수
        async function loadData(base, endpoint, renderCallback, id) {
            try {
                let  response;
                if (id == null)
                    response = await fetch(`/v1/${base}/${endpoint}`);
                else
                    response = await fetch(`/v1/${base}/${endpoint}/${id}`);
                if (!response.ok) {
                    throw new Error(`Failed to load ${endpoint}: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!renderCallback)
                    return data;
                await renderCallback(data);
            } catch (error) {
                console.error(`Error loading ${endpoint}:`, error);
                // alert(`Failed to load ${endpoint}. Please check console for details.`);
            }
        }

        function renderToSelect(selectId, textFormatter) {
            return data => {
                const select = document.getElementById(selectId);
                
                // 기존 옵션 제거 (첫 번째 기본 옵션 제외)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // 새 옵션 추가
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.text = textFormatter(item);
                    select.appendChild(option);
                });
            };
        }

        // 테이블에 VM 데이터 렌더링 함수
        function renderToTable(tableBodyId, columnRenderer, actionRenderer) {
            return async data => {
                const tbody = document.getElementById(tableBodyId);
                tbody.innerHTML = '';
                for (const item of data) {
                    const row = document.createElement('tr');
                    const columnsHtml = await columnRenderer(item); // 비동기 처리
                    const actionsHtml = actionRenderer ? `<td>${actionRenderer(item)}</td>` : '';
                    row.innerHTML = columnsHtml + actionsHtml;
                    tbody.appendChild(row);
                }
            };
        }
        // 리소스별 로딩 함수

        function createImage() {
            // 이미지 생성 모달 또는 폼을 표시하는 로직
            alert("Create Image functionality will be implemented here");
        }

        async function loadFlavors() {
            await loadData('compute', 'flavors', renderToSelect('flavorId', flavor => `${flavor.name} (${flavor.id})`));
        }

        async function loadNetworks() {
            try {
                const networks = await loadData('network', 'networks');
                
                // 선택 목록에 렌더링
                renderToSelect('networkId', network => `${network.name} (${network.name})`)(networks);
                // console.log("network.id:", network.id);
                // const subnet = await loadData('network', 'networks', null, network.id);
                // 테이블에 렌더링
                await renderToTable(
                    'networkList',
                async network => {
                    let subnetName = 'N/A';
                    if (network.subnets && network.subnets.length > 0) {
                        try {
                            const subnet = await loadData('network', 'subnets', null, network.subnets[0]);
                            if (subnet && subnet.name) {
                                subnetName = subnet.name;
                            }
                        } catch (error) {
                            console.error(`Error loading subnet for network ${network.id}:`, error);
                        }
                    }
                    return `
                    <td>${network.name || 'N/A'}</td>
                    <td>${subnetName}</td>
                    <td>${network.shared !== undefined ? network.shared : 'N/A'}</td>
                    <td>${network.status || 'N/A'}</td>
                    <td>${network.availability_zones ? network.availability_zones.join(', ') : 'N/A'}</td>
                `;
            },
                    network => `
                        <button onclick="deleteNetwork('${network.id}')">Delete Network</button>
                    `
                )(networks);
                const table = document.getElementById('networkList').closest('table');
                const headerRow = table.querySelector('thead tr');
                const actionHeader = headerRow.cells[headerRow.cells.length - 1]; // 마지막 열 (Actions)
                actionHeader.innerHTML = '<button onclick="create Network()">Create Network</button>';
            } catch (error) {
                console.error('Error loading networkLists:', error);
            }
        }

        async function loadImages() {
            try {
                const images = await loadData('compute', 'images');
                // 선택 목록에 렌더링
                renderToSelect('imageId', image => `${image.name} (${image.name})`)(images);
                
                // 테이블에 렌더링
                renderToTable(
                    'imageList',
                    // 이미지용 컬럼 렌더러
                    image => `
                        <td>${image.name}</td>
                        <td>${image.status || 'N/A'}</td>
                        <td>${image.visibility}</td>
                        <td>${image.protected}</td>
                        <td>${image.disk_format}</td>
                        <td>${Math.round(image.size / (1024 * 1024))} MB</td>
                    `,
                    // 이미지용 액션 렌더러
                    image => `
                        <button onclick="deleteImage('${image.id}')">Delete Image</button>
                    `
                )(images);
                const table = document.getElementById('imageList').closest('table');
                const headerRow = table.querySelector('thead tr');
                const actionHeader = headerRow.cells[headerRow.cells.length - 1]; // 마지막 열 (Actions)
                actionHeader.innerHTML = '<button onclick="create Image()">Create Image</button>';
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }
        async function loadVMs() {
            loadData('compute','vms', renderToTable(
                'vmList',
                // VM용 컬럼 렌더러
                vm => `
                    <td>${vm.name}</td>
                    <td>${vm.name}</td>
                    <td>${vm.name}</td>
                    <td>${vm.name}</td>
                    <td>${vm.status}</td>
                    <td>${vm['OS-EXT-AZ:availability_zone']}</td>
                    <td>${vm['OS-EXT-STS:task_state']}</td>
                    <td>${vm['OS-EXT-STS:vm_state']}</td>
                    <td>${Math.floor((new Date(vm.updated) - new Date(vm.created)) / (1000 * 60 * 60))}h</td>
                `,
                // VM용 액션 렌더러
                vm => `
                    <button onclick="alert('Starting VM...'); vmAction('${vm.id}', 'os-start')">Start</button>
                    <button onclick="alert('Stopping VM...'); vmAction('${vm.id}', 'os-stop')">Stop</button>
                    <button onclick="alert('Deleting VM...'); vmAction('${vm.id}', 'delete')">Delete</button>
                `
            ));
        }

        async function createVM() {
            const vmData = {
                name: document.getElementById('vmName').value,
                imageId: document.getElementById('imageId').value,
                flavorId: document.getElementById('flavorId').value,
                networkId: document.getElementById('networkId').value
            };
            
            // 입력 검증
            if (!vmData.name) {
                alert('Please enter a VM name');
                return;
            }
            if (!vmData.imageId) {
                alert('Please select an image');
                return;
            }
            if (!vmData.flavorId) {
                alert('Please select a flavor');
                return;
            }
            if (!vmData.networkId) {
                alert('Please select a network');
                return;
            }
            
            try {
                const response = await fetch('/v1/compute/vms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(vmData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create VM');
                }
                
                alert('VM created successfully!');
                loadVMs();
            } catch (error) {
                console.error('Error creating VM:', error);
                alert(`Failed to create VM: ${error.message}`);
            }
        }

        async function vmAction(vmId, action) {
            try {
                const response = await fetch(`/v1/compute/vms/${vmId}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Failed to perform action: ${action}`);
                }
                
                loadVMs();
            } catch (error) {
                console.error(`Error performing VM action (${action}):`, error);
                alert(`Failed to perform action: ${error.message}`);
            }
        }

        // 페이지 초기화 함수
        function init() {
            loadImages();
            loadFlavors();
            loadNetworks();
            loadVMs();
        }

        // 페이지 로드 시 초기화
        init();
    </script>
</body>
</html>